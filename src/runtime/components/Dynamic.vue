<template>
  <component
    v-if="lazyComponent"
    :is="lazyComponent"
    v-bind="{
      ...$attrs,
      component,
    }"
    v-on="$listeners"
    :ref="componentRef"
  >
    <!-- pass through normal slots -->
    <template v-for="(_, slotName) in $slots" v-slot:[slotName]>
      <slot :name="slotName" />
    </template>

    <!-- pass through scoped slots -->
    <template
      v-for="(_, scopedSlotName) in $scopedSlots"
      v-slot:[scopedSlotName]="slotData"
    >
      <slot :name="scopedSlotName" v-bind="slotData" />
    </template>
  </component>
</template>

<script>
import {
  hydrateOnInteraction,
  hydrateWhenIdle,
  hydrateWhenVisible,
  hydrateNever
} from "vue-lazy-hydration";

import { toPascalCase } from "./../utils/cases";

// inspiration for slot handling:
// https://gist.github.com/loilo/73c55ed04917ecf5d682ec70a2a1b8e2
export default {
  name: "Dynamic",

  inheritAttrs: false,

  props: {
    component: {
      type: String,
      default: null,
    },
    componentRef: {
      type: String|Number,
      default: null,
    },
    /**
     * options: [
     *   OnInteraction,
     *   WhenIdle,
     *   WhenVisible,
     *   Never,
     * ]
     */
    hydration: {
      type: String,
      default: "WhenIdle",
    },
  },

  computed: {
    hydrate() {
      return this[`hydrate${this.hydration}`] ?? null;
    },

    name() {
      return this.component ?? this.$attrs.name;
    },

    componentLoader() {
      const ndLoaders = this.$nuxtDynamic.loaders;

      console.log("loaders", ndLoaders, toPascalCase(`Lazy${this.name}`))

     const component = toPascalCase(`Lazy${this.name}`) in ndLoaders

console.log("comp",component)

      if (!component && this.$nuxtDynamic.debug) {
        return this.$nuxtDynamic.loaders['LazyBlokDebug']
      }


      const loaders = ["", ...this.$nuxtDynamic.prefixes]
        .map((prefix) => {
          const name = `Lazy${toPascalCase(prefix)}${toPascalCase(this.name)}`;
          return name in this.$nuxtDynamic.loaders
            ? this.$nuxtDynamic.loaders[name]
            : null;
        })
        .filter((loader) => loader);

console.log("shift", loaders.shift() ?? null)

      return loaders.shift() ?? null;
    },

    lazyComponent() {
      return this.hydrate && this.componentLoader
        ? this.hydrate(this.componentLoader)
        : this.name;
    },
  },

  methods: {
    hydrateOnInteraction: hydrateOnInteraction,
    hydrateWhenIdle: hydrateWhenIdle,
    hydrateWhenVisible: hydrateWhenVisible,
    hydrateNever: hydrateNever,
  },
};
</script>
